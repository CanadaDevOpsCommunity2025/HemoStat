# Docker Compose for Testing HemoStat with Broken Containers
# Usage: docker compose -f docker-compose.yml -f docker-compose.test.yml -f docker-compose.windows.yml --env-file .env.docker.windows up -d

services:
  # 1. Crash Loop - Exits immediately and restarts
  test-crash-loop:
    image: alpine:latest
    container_name: test-crash-loop
    command: sh -c 'echo "Crashing..."; sleep 3; exit 1'
    restart: always
    networks:
      - hemostat-network

  # 2. High CPU Stress
  test-cpu-stress:
    image: polinux/stress:latest
    container_name: test-cpu-stress
    command: stress --cpu 2 --timeout 600s
    restart: unless-stopped
    networks:
      - hemostat-network

  # 3. High Memory Stress (256MB)
  test-memory-stress:
    image: polinux/stress:latest
    container_name: test-memory-stress
    command: stress --vm 1 --vm-bytes 256M --timeout 600s
    restart: unless-stopped
    networks:
      - hemostat-network

  # 4. Failing Healthcheck
  test-failing-healthcheck:
    image: alpine:latest
    container_name: test-failing-healthcheck
    command: sleep 3600
    healthcheck:
      test: ["CMD", "sh", "-c", "exit 1"]
      interval: 10s
      timeout: 5s
      retries: 2
      start_period: 5s
    restart: unless-stopped
    networks:
      - hemostat-network

  # 5. OOM Killer (intentionally exceeds memory limit)
  test-oom-killer:
    image: polinux/stress:latest
    container_name: test-oom-killer
    command: stress --vm 1 --vm-bytes 512M --timeout 600s
    mem_limit: 256m
    restart: unless-stopped
    networks:
      - hemostat-network

  # 6. Random Exit (exits after random time)
  test-random-exit:
    image: alpine:latest
    container_name: test-random-exit
    command: sh -c 'WAIT=$$((1 + RANDOM % 30)); echo "Will exit after $$WAIT seconds"; sleep $$WAIT; exit 1'
    restart: always
    networks:
      - hemostat-network

  # 7. Combined CPU + Memory Stress
  test-combined-stress:
    image: polinux/stress:latest
    container_name: test-combined-stress
    command: stress --cpu 1 --vm 1 --vm-bytes 128M --timeout 600s
    restart: unless-stopped
    networks:
      - hemostat-network

  # 8. Healthy Container (for comparison)
  test-healthy:
    image: nginx:alpine
    container_name: test-healthy
    restart: unless-stopped
    networks:
      - hemostat-network

networks:
  hemostat-network:
